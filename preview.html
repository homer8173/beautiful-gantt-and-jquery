<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Table colgroup scrollable right + durée + avancement + parentalité + séparateurs</title>
    <link href="https://cdn.jsdelivr.net/npm/@fontsource/fira-sans@5.0.12/index.css" rel="stylesheet">
    <style>
        :root {
            --gantt-bg: #f9fafb;
            --gantt-card: #fff;
            --gantt-border: #eceff2;
            --gantt-text-main: #555;
            --gantt-header: #888;
            --bar-prod-main: #66bc8a;
            --bar-prod-dark: #3a8f5f;
            --bar-prod-border: #9ad9b2;
            --bar-prod-progress: #2d8b5a;
            --bar-qa-main: #ffe080;
            --bar-qa-dark: #ffb100;
            --bar-qa-border: #ffe8aa;
            --bar-qa-progress: #bf7a01;
            --bar-ship-main: #ff9494;
            --bar-ship-dark: #e86666;
            --bar-ship-border: #ffc0c0;
            --bar-ship-progress: #b84040;
            --arrow-default: #aab;
            --gantt-grid: #7788a033;
            --gantt-grid-bold: #6688bb77;
            --gantt-we-bg: #f9fafb;
        }
        body { font-family: 'Fira Sans', Arial, sans-serif; background: var(--gantt-bg); margin: 0; padding: 40px; }
        .gantt-table-main { border-collapse: collapse; background: var(--gantt-card); border-radius: 18px; box-shadow: 0 4px 18px 0 rgba(40,40,60,0.12); width: auto; min-width: 900px; margin: 0; overflow: visible; }
        .gantt-table-main td, .gantt-table-main th { padding: 0; margin: 0; }
        .gantt-label-col { width: 180px; min-width: 140px; max-width: 240px; text-align: left; font-weight: 600; font-size: 15px; background: var(--gantt-bg); color: var(--gantt-text-main); padding: 0 18px 0 18px; border-right: 1.5px solid var(--gantt-border); white-space: nowrap; vertical-align: middle; }
        .gantt-scroll-td { padding: 0; margin: 0; }
        .gantt-scroll-wrap { overflow-x: auto; min-width: 400px; max-width: 75vw; border-radius: 12px; background: var(--gantt-card); }
        table.gantt-inner-table { border-collapse: separate; border-spacing: 0; width: max-content; min-width: 600px; }
        .gantt-inner-table th { height: 36px; text-align: center; color: var(--gantt-header); font-size: 13px; font-weight: 700; background: var(--gantt-card); border-bottom: 2px solid var(--gantt-border); border-right: 1px solid var(--gantt-border); min-width: 50px; }
        .gantt-inner-table th.weekend { background: var(--gantt-we-bg) !important; }
        .gantt-inner-table td { height: 46px; background: none; position: relative; border-right: 1px solid var(--gantt-border); }
        .gantt-inner-table td.weekend { background: var(--gantt-we-bg) !important; }
        .gantt-separator td {
            border-bottom: 2px dashed var(--gantt-border);
            height: 3px;
            background: transparent !important;
            padding: 0;
        }
        .gantt-bar { position: absolute; height: 26px; border-radius: 7px; cursor: pointer; background: var(--bar-prod-main); box-shadow: 0 2px 6px rgba(70,120,200,0.06); transition: box-shadow 0.15s, transform 0.12s; border: 2px solid var(--bar-prod-border); top: 10px; left: 0; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; color: #fff; text-shadow: 0 1px 3px #234a3d77, 0 0 2px #2228; letter-spacing: 0.5px; overflow: hidden; white-space: nowrap; z-index: 10; }
        .gantt-bar-progress { position: absolute; top: 0; left: 0; height: 6px; border-radius:  0; z-index: 11; opacity: 0.93; }
        .gantt-bar[data-type='production'] { background: linear-gradient(180deg, var(--bar-prod-main) 10%, var(--bar-prod-dark) 100%); border-color: var(--bar-prod-border); }
        .gantt-bar[data-type='qa'] { background: linear-gradient(180deg, var(--bar-qa-main) 10%, var(--bar-qa-dark) 100%); border-color: var(--bar-qa-border); color: #a96b00; text-shadow: 0 1px 3px #ffc84577; }
        .gantt-bar[data-type='shipping'] { background: linear-gradient(180deg, var(--bar-ship-main) 10%, var(--bar-ship-dark) 100%); border-color: var(--bar-ship-border); }
        .gantt-bar-progress[data-type='production'] { background: var(--bar-prod-progress); }
        .gantt-bar-progress[data-type='qa'] { background: var(--bar-qa-progress); }
        .gantt-bar-progress[data-type='shipping'] { background: var(--bar-ship-progress); }
        .gantt-bar .gantt-bar-duration { display: block; text-align: center; width: 100%; pointer-events: none; user-select: none; font-size: 13px; font-weight: 700; z-index: 12; }
    </style>
</head>
<body>
<table class="gantt-table-main">
    <tr>
        <td class="gantt-label-col">&nbsp;</td>
        <td class="gantt-scroll-td" rowspan="2">
            <div class="gantt-scroll-wrap">
                <table class="gantt-inner-table" id="gantt-inner-table">
                    <thead><tr id="gantt-inner-header-row"></tr></thead>
                    <tbody id="gantt-inner-table-body"></tbody>
                </table>
            </div>
        </td>
    </tr>
    <tr>
        <td class="gantt-label-col" id="gantt-labels-col"></td>
    </tr>
</table>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
// Helper pour formater une date en YYYY-MM-DD local
function toYMD(d) {
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
// Retourne la durée en string lisible
function msToDuration(ms) {
    let min = Math.floor(ms/60000);
    let h = Math.floor(min/60); min = min%60;
    let d = Math.floor(h/24); h = h%24;
    let parts = [];
    if (d) parts.push(d+'j');
    if (h) parts.push((d?String(h).padStart(2,'0'):h)+'h');
    if (min) parts.push((h||d?String(min).padStart(2,'0'):min)+'m');
    return parts.join('');
}
function parseLocalDate(str) {
    let m;
    if ((m = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(str))) {
        return new Date(+m[1], +m[2]-1, +m[3], 0, 0, 0, 0);
    }
    if ((m = /^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2})/.exec(str))) {
        return new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], 0, 0);
    }
    if ((m = /^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})/.exec(str))) {
        return new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], +m[6], 0);
    }
    return new Date(str);
}
// Retourne la durée en ms, jusqu'à la fin du jour de fin si pas d'heure, sinon à la date exacte
function durationBetween(start, end, forceMs) {
    if (forceMs) return msToDuration(forceMs);
    let s = parseLocalDate(start);
    let e;
    if (/^\d{4}-\d{2}-\d{2}$/.test(end)) {
        e = parseLocalDate(end);
        e = new Date(e.getFullYear(), e.getMonth(), e.getDate() + 1, 0, 0, 0, 0); // 00:00 du lendemain
    } else {
        e = parseLocalDate(end);
    }
    let ms = e - s;
    return msToDuration(ms);
}

  
function addDays(date, days) {
    let d = new Date(date);
    d.setDate(d.getDate() + days);
    return d;
}

function getBarOffsetAndWidth(start, end, dayWidth) {
    let s = parseLocalDate(start);
    let e = parseLocalDate(end);
    if (/^\d{4}-\d{2}-\d{2}$/.test(end)) {
        e = new Date(e.getFullYear(), e.getMonth(), e.getDate() + 1, 0, 0, 0, 0);
    }
    let totalMs = e - s;
    let width = totalMs / 86400000 * dayWidth;
    let offset = 0;
    return { offset, width };
}
const startDate = new Date('2025-07-07');
const endDate = new Date('2025-07-28');
const dayWidth = 50;
const tasks = [
    {id:1, label:'Préparation matière', start:'2025-07-07', end:'2025-07-10', type:'production', durationMs: null, progress: 0.7, dependsOn:[]},
    {id:2, label:'Montage', start:'2025-07-11', end:'2025-07-16', type:'production', durationMs: null, progress: 0.6, dependsOn:[1]},
    {id:3, label:'Contrôle qualité', start:'2025-07-17', end:'2025-07-19', type:'qa', durationMs: null, progress: 0.3, dependsOn:[2]},
    {id:4, label:'Expédition', start:'2025-07-21', end:'2025-07-23', type:'shipping', durationMs: null, progress: 0.1, dependsOn:[3]},
    {id:5, label:'Test court', start:'2025-07-24T09:00', end:'2025-07-24T12:15', type:'qa', durationMs: null, progress: 0.5, dependsOn:[]},
    {id:6, label:'Ultra rapide', start:'2025-07-25T14:00', end:'2025-07-25T14:18', type:'shipping', durationMs: null, progress: 0.9, dependsOn:[]}
];
function dateDiffDays(d1, d2) {
    return Math.round((d2-d1)/86400000);
}
function buildInnerHeader(startDate, endDate) {
    let days = [];
    let dt = new Date(startDate);
    let nbdays = dateDiffDays(startDate, endDate) + 1;
    for(let i = 0; i < nbdays; i++) {
        let day = dt.getDate();
        let month = (dt.getMonth() + 1).toString().padStart(2, '0');
        let isWeekend = (dt.getDay()===0 || dt.getDay()===6);
        days.push('<th class="'+(isWeekend?'weekend':'')+'" style="min-width:'+dayWidth+'px">' + day + '/' + month + '</th>');
        dt = addDays(dt, 1);
    }
    $('#gantt-inner-header-row').html(days.join(''));
}
function buildLabelsCol(tasks) {
    let html = '';
    tasks.forEach(task => {
        let prefix = (task.dependsOn && task.dependsOn.length) ? '↳ ' : '';
        html += `<div style="height:46px;line-height:46px;">${prefix}${task.label}</div>`;
    });
    $('#gantt-labels-col').html(html);
}
function buildInnerTableBody(tasks, startDate, endDate) {
    let nbdays = dateDiffDays(startDate, endDate) + 1;
    let rows = '';
    function toYMD(d) {
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    }
    for (let t = 0; t < tasks.length; t++) {
        let task = tasks[t];
        // Ajoute une ligne séparatrice avant chaque tâche sans parent (sauf la 1ère)
        if (t > 0 && (!task.dependsOn || !task.dependsOn.length)) {
            rows += `<tr class="gantt-separator"><td colspan="${nbdays}"></td></tr>`;
        }
        rows += '<tr>';
        let dt = new Date(startDate);
        for(let i = 0; i < nbdays; i++) {
            let isWeekend = (dt.getDay()===0 || dt.getDay()===6);
            let d = new Date(dt);
            let barStartDate = parseLocalDate(task.start);
            const isSameLocalDay = toYMD(d) === toYMD(barStartDate);
            if(isSameLocalDay) {
                const { offset, width } = getBarOffsetAndWidth(task.start, task.end, dayWidth);
                let durationLabel = durationBetween(task.start, task.end, task.durationMs);
                let progress = typeof task.progress === 'number' ? Math.max(0, Math.min(task.progress, 1)) : 0;
                let progressWidth = Math.round(width * progress);
                let barStyle = `left:${offset}px;width:${width-8}px;z-index:11;`;
                if(width <= 0) {
                    barStyle = 'left:0px;width:48px;z-index:99;background:red;border:2px solid #222;';
                }
                rows += `<td class="${isWeekend ? 'weekend' : ''}" style="position:relative;width:${dayWidth}px;height:46px">`;
                rows += `<div class="gantt-bar" data-id="${task.id}" data-type="${task.type}" style="${barStyle}" title="${task.label}\n${task.start} → ${task.end}\nDurée : ${durationLabel}\nAvancement : ${Math.round(progress*100)}%" data-url="${task.edit_url||'#'}">
                    <div class="gantt-bar-progress" data-type="${task.type}" style="width:${progressWidth}px;"></div>
                    <span class="gantt-bar-duration">${durationLabel}</span>
                </div>`;
                rows += '</td>';
            } else {
                rows += `<td class="${isWeekend ? 'weekend' : ''}" style="position:relative;width:${dayWidth}px;height:46px"></td>`;
            }
            dt = addDays(dt,1);
        }
        rows += '</tr>';
    }
    $('#gantt-inner-table-body').html(rows);
}
$(document).on('click', '.gantt-bar', function() {
    let url = $(this).data('url');
    if(url && url !== '#') window.location.href = url;
});
function renderGanttTable() {
    buildInnerHeader(startDate, endDate);
    buildLabelsCol(tasks);
    buildInnerTableBody(tasks, startDate, endDate);
}
$(function() {
    renderGanttTable();
});
</script>
</body>
</html>
